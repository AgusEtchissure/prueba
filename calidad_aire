#include "GravityRtc.h"
#include "Wire.h" 
#include <SPI.h> 
#include <SD.h>
#include "DFRobot_OzoneSensor.h"

#define COLLECT_NUMBER  20              
#define Ozone_IICAddress OZONE_ADDRESS_3

DFRobot_OzoneSensor Ozone;

 
GravityRtc rtc;     //RTC Initialization

int ozono;
int co;

int sensorIn = A0;


File dataFile;


void setup() {
  Serial.begin(9600);
 
  rtc.setup();

  analogReference(DEFAULT);
 
 
  //Set the RTC time manually
  rtc.adjustRtc(2023,4,24,1,15,0,0);  //Set time: 2017/6/19, Monday, 12:07:00
 
  while (!Serial) {
    ; // Espera a que se inicie el puerto serial
  }
  Serial.print("Inicializando tarjeta SD ...");
 
  // Verifica que la tarjeta se inicialice
  if (!SD.begin(4)) {
    Serial.println("Fallo en tarjeta, o no hay tarjeta");
    return;  // No hace nada m치s:
  }
  Serial.println("Tarjeta lista");
   SD.remove("datalog.txt");  //Borra el archivo previo
 
    while(!Ozone.begin(Ozone_IICAddress)) {
    Serial.println("I2c error de medici칩n!");
    delay(1000);
  }  Serial.println("I2c conexi칩n exitosa!");
 
}
 
void loop() {

rtc.read();
  //*************************Time********************************
 String dataString3 = "";
 String dataString4 = "";
 String dataString5 = "";

 ozono = Ozone.readOzoneData(COLLECT_NUMBER);
 int val = digitalRead(4);//Read Gas value from analog 0
 co = (val,DEC);
 int CO2 = analogRead(sensorIn);

 dataString3 += String(ozono);
 dataString4 += String(co);
 dataString5 += String(CO2);
 delay(500);
   // Abre el archivo en la memoria SD
  File dataFile = SD.open("datalog.txt", FILE_WRITE);
  // Revisa si el archivo est치 disponible para escribir:
  if (dataFile) {
  dataFile.print(rtc.day);
  dataFile.print("/");//month
  dataFile.print(rtc.month);
  dataFile.print("/");//day
  dataFile.print(rtc.year);
  dataFile.print("    ");  
  dataFile.print(rtc.hour);
  dataFile.print(":");//minute
  dataFile.print(rtc.minute);
  dataFile.print(":");//second
  dataFile.print(rtc.second);
  dataFile.print(";   ");//second
  dataFile.print(dataString3);
  dataFile.print("; ");
  dataFile.print(dataString4);
  dataFile.print("; ");
  dataFile.print(dataString5);
  dataFile.println("; ");
  dataFile.close();
 


  delay(30000);   // Toma un dato cada 30 segundos
 
   }
  // Si el archivo no se encuentra abierto, manda un error:
  else {
    Serial.println("Error al abrir el archivo datalog.txt");
  }
 
  //HOLA COMO ESTAS
 
}
